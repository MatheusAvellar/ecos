<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Projeto Ecos Urbanos</title>
  <meta content="Matheus Avellar" name="author">
  <meta name="description" content="Pela preservação de sons urbanos.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="referrer" content="no-referrer">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <header>
    <div id="banner" class="full-bleed" style="background-image:url(./assets/banner-smol.jpg)"></div>
    <p class="banner-credits">
      By Andrés Franchi<br>
      Ugartemendía,<br>
      via <a href="https://commons.wikimedia.org/wiki/File:Rio_de_Janeiro_Brasil_-_panoramio_(7).jpg">Commons</a>,<br>
      under CC-BY-SA
    </p>
    <h1>
      <span class="word">
        <span class="letter">P</span>rojeto
      </span>
      <span class="line-2">
        <span class="word">
          <span class="letter">E</span>cos
        </span>
        <span class="ornament"></span>
      </span>
      <span class="word">
        <span class="letter">U</span>rbanos
      </span>
    </h1>
    <p class="subtitle">Pela preservação de sons urbanos.</p>
  </header>
  <main>
    <hr>
    <article class="audio-sample">
      <h2 id="ferro-velho">Carro do ferro velho</h2>
      <div class="waveform"></div>
      <audio controls>
        <source src="assets/ferro-velho/audio.mp3" type="audio/mp3">
        <track class="texttrack" kind="captions" src="assets/ferro-velho/caption.vtt" srclang="pt-br" default>
      </audio>
      <output class="captions"></output>
      <div class="extras">
        <p>
          Música usada:
        </p>
        <div>
          <audio controls src="assets/ferro-velho/musica.mp3" type="audio/mp3"></audio>
          <p>
            "<a href="https://youtu.be/SdkWBHLHTgg?t=45">Uma Nova História</a>",
            de Fernandinho
          </p>
        </div>
      </div>
    </article>
    <hr>
    <article class="audio-sample">
      <h2 id="coratine-gelateria">Coratine gelateria</h2>
      <img class="photo" src="assets/coratine-gelateria/image.png">
      <div class="waveform"></div>
      <audio controls>
        <source src="assets/coratine-gelateria/audio.mp3" type="audio/mp3">
        <!-- <track class="texttrack" kind="captions" src="assets/coratine-gelateria/caption.vtt" srclang="pt-br" default> -->
      </audio>
      <output class="captions"></output>
      <div class="extras">
        <p>
          Início alternativo, antes da narração:
        </p>
        <audio controls src="assets/coratine-gelateria/alt.mp3" type="audio/mp3"></audio>
        <p>
          Música usada:
        </p>
        <p>
          (ainda não identificada)
        </p>
      </div>
    </article>
    <script src="wavesurfer.min.js"></script>
    <script>
const samples = document.getElementsByClassName("audio-sample");
[...samples].forEach(article => {
  const wav = article.querySelector("div.waveform");
  const audio = article.querySelector("audio");
  const src = audio.querySelector("source").getAttribute("src");
  const track = audio.querySelector("track");

  const output = article.querySelector("output.captions");

  let first_subtitle = null;
  const subtitles = {};
  const spacing = 1.25;

  if(track) {
    track.addEventListener("load", () => {
      const cues = [...track.track.cues].map(v => [v.text, v.startTime]);

      cues.forEach(([text, start_time], index) => {
        const p = document.createElement("p");
        p.textContent = text;
        subtitles[start_time] = [ p, index ];
        output.appendChild(p);
      });
      first_subtitle = output.firstElementChild;
      first_subtitle.style.marginTop = `${spacing}em`;
    });

    track.addEventListener("cuechange", event => {
      const activecues = event.target.track.activeCues;

      if(activecues.length > 0) {
        const text = activecues[0].text;
        const start_time = activecues[0].startTime;
        if(start_time in subtitles) {
          output.querySelectorAll("[data-selected]").forEach(e => {
            e.removeAttribute("data-selected");
          });
          const subtitle = subtitles[start_time];
          subtitle[0].dataset.selected = "true";
          first_subtitle.style.marginTop = `${subtitle[1] * -1.25}em`;
        }
      }
    });
  }

  const wavesurfer = WaveSurfer.create({
    container: wav,
    scrollParent: true,
    minPxPerSec: 10,
    waveColor: "#dbe1e5",
    progressColor: "crimson",
    interact: false,
    barWidth: 3,
    barRadius: 3,
    barGap: 3,
    hideScrollbar: true
  });
  wavesurfer.load(src);
  wavesurfer.setMute(true);

  function updateWavesurferSeek() {
    wavesurfer.seekTo(audio.currentTime / audio.duration);
  }
  audio.addEventListener("play", function() {
    wavesurfer.play();
    updateWavesurferSeek();
  });
  audio.addEventListener("pause", function() {
    wavesurfer.pause();
    updateWavesurferSeek();
  });
  audio.addEventListener("seeked", updateWavesurferSeek);
});
    </script>
  </main>
  <footer>
    <p class="sign">
      Feito com ♥︎&#xFE0E;<!--&#xFE0E;[Ref] stackoverflow.com/a/38452396/4824627-->
      por Matheus Avellar<br>Rio de Janeiro, 2022
    </p>
    <p class="credits">
      Todos os áudios do projeto estão disponíveis ao domínio público.
    </p>
    <p class="credits">
      Este projeto usa a biblioteca wavesurfer.js, disponível sob a licença
      <a href="https://opensource.org/licenses/BSD-3-Clause">BSD 3-Clause</a>.
      Você pode encontrar seus termos e código fonte em:
      <a href="https://github.com/katspaugh/wavesurfer.js">github.com/katspaugh/wavesurfer.js</a>
    </p>
  </footer>
  <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">
</body>
</html>